<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @tailwind base;
        @tailwind components;
        @tailwind utilities;
    </style>
</head>

<body>
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Dashboard</h1>
        <div id="traffic-stats" class="mb-4">
            <h2 class="text-xl font-semibold mb-2">Traffic Statistics</h2>
            <div id="stats-content" class="bg-white p-4 rounded shadow">
                Loading...
            </div>
        </div>
        <!-- chart -->
        <div id="traffic-chart" class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Traffic Charts</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-medium mb-2">Vehicle Count (Total / Left / Right)</h3>
                    <canvas id="countChart" height="180"></canvas>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-medium mb-2">Average Speed (km/h)</h3>
                    <canvas id="speedChart" height="180"></canvas>
                </div>
            </div>
            <div id="video-stream">
                <h2 class="text-xl font-semibold mb-2">Live Video Stream</h2>
                <img id="video-stream-img" alt="Live Stream" class="w-full rounded shadow" />
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script>
            const MAX_POINTS = 30; // 保留最新 30 筆
            const series = {
                labels: [],
                total: [],
                left: [],
                right: [],
                avgSpeed: [],
                leftSpeed: [],
                rightSpeed: []
            };
            let countChart, speedChart;

            async function fetchVideoUrl() {
                try {
                    const response = await fetch('/api/video/url/');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    const videoStream = document.getElementById('video-stream-img');
                    videoStream.src = data.url;
                } catch (error) {
                    console.error('Error fetching video URL:', error);
                }
            }

            async function fetchTrafficAllStats() {
                try {
                    const response = await fetch('/api/traffic/all/');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    console.log('Fetched all traffic stats:', data);
                    if (!data.data || data.data.length === 0) {
                        return;
                    }
                    // 重建序列
                    series.labels = [];
                    series.total = [];
                    series.left = [];
                    series.right = [];
                    series.avgSpeed = [];
                    series.leftSpeed = [];
                    series.rightSpeed = [];
                    data.data.forEach(item => {
                        const d = item;
                        const label = item.ts ? new Date(item.ts).toLocaleTimeString() : new Date().toLocaleTimeString();
                        series.labels.push(label);
                        series.total.push(d.total_count);
                        series.left.push(d.left_count);
                        series.right.push(d.right_count);
                        series.avgSpeed.push(d.avg_speed);
                        series.leftSpeed.push(d.avg_left_speed);
                        series.rightSpeed.push(d.avg_right_speed);
                    });
                    // 限制長度
                    if (series.labels.length > MAX_POINTS) {
                        const excess = series.labels.length - MAX_POINTS;
                        Object.keys(series).forEach(k => series[k] = series[k].slice(excess));
                    }
                    updateCharts();
                } catch (error) {
                    console.error('Error fetching all traffic stats:', error);
                }
            }

            async function fetchTrafficStats() {
                try {
                    const response = await fetch('/api/traffic/latest/');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    const statsContent = document.getElementById('stats-content');
                    console.log('Fetched traffic stats:', data);
                    if (!data.data) {
                        statsContent.innerHTML = '<p class="text-gray-500">尚無資料，稍後自動再試...</p>';
                        return;
                    }
                    const d = data.data;
                    statsContent.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                      <div><span class="font-medium">Total:</span> ${d.total_count}</div>
                      <div><span class="font-medium">Left:</span> ${d.left_count}</div>
                      <div><span class="font-medium">Right:</span> ${d.right_count}</div>
                      <div><span class="font-medium">Rate:</span> ${(d.rate).toFixed(2)}/s</div>
                      <div><span class="font-medium">Avg Speed:</span> ${d.avg_speed.toFixed(2)}</div>
                      <div><span class="font-medium">Left Speed:</span> ${d.avg_left_speed.toFixed(2)}</div>
                      <div><span class="font-medium">Right Speed:</span> ${d.avg_right_speed.toFixed(2)}</div>
                      <div><span class="font-medium">Updated:</span> ${data.ts ? new Date(data.ts).toLocaleTimeString() : '-'}</div>
                    </div>
                `;

                    // 資料推入序列
                    const label = data.ts ? new Date(data.ts).toLocaleTimeString() : new Date().toLocaleTimeString();
                    series.labels.push(label);
                    series.total.push(d.total_count);
                    series.left.push(d.left_count);
                    series.right.push(d.right_count);
                    series.avgSpeed.push(d.avg_speed);
                    series.leftSpeed.push(d.avg_left_speed);
                    series.rightSpeed.push(d.avg_right_speed);
                    // 限制長度
                    if (series.labels.length > MAX_POINTS) {
                        Object.keys(series).forEach(k => series[k].shift());
                    }
                    updateCharts();
                } catch (error) {
                    console.error('Error fetching traffic stats:', error);
                    document.getElementById('stats-content').innerText = 'Error loading data.';
                }
            }
            function buildCharts() {
                const countCtx = document.getElementById('countChart');
                const speedCtx = document.getElementById('speedChart');
                countChart = new Chart(countCtx, {
                    type: 'line',
                    data: {
                        labels: series.labels,
                        datasets: [
                            { label: 'Total', data: series.total, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.2)', tension: .25 },
                            { label: 'Left', data: series.left, borderColor: '#16a34a', backgroundColor: 'rgba(22,163,74,0.2)', tension: .25 },
                            { label: 'Right', data: series.right, borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.2)', tension: .25 },
                        ]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { y: { beginAtZero: true } }
                    }
                });
                speedChart = new Chart(speedCtx, {
                    type: 'line',
                    data: {
                        labels: series.labels,
                        datasets: [
                            { label: 'Avg', data: series.avgSpeed, borderColor: '#7c3aed', backgroundColor: 'rgba(124,58,237,0.25)', tension: .25 },
                            { label: 'Left', data: series.leftSpeed, borderColor: '#059669', backgroundColor: 'rgba(5,150,105,0.25)', tension: .25 },
                            { label: 'Right', data: series.rightSpeed, borderColor: '#ea580c', backgroundColor: 'rgba(234,88,12,0.25)', tension: .25 },
                        ]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
            function updateCharts() {
                if (!countChart || !speedChart) return;
                countChart.update();
                speedChart.update();
            }
            fetchVideoUrl();
            // Fetch stats on page load
            fetchTrafficStats();
            fetchTrafficAllStats();
            buildCharts();
            // Refresh stats every minute (可視情況縮短)
            setInterval(()=>{
                fetchTrafficStats();
                fetchTrafficAllStats();
                buildCharts();
            }, 60000);
        </script>
</body>

</html>